(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{335:function(s,a,n){"use strict";n.r(a);var e=n(0),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"tip custom-block"},[n("p",{staticClass:"custom-block-title"},[s._v("介绍")])]),s._v(" "),n("h2",{attrs:{id:"原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理","aria-hidden":"true"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),n("p",[s._v("master主机上的kube-controller-manager是整个集群的控制管理中心，kube-controler-manager中的node controller模块 通过apiservice提供的监听接口，实时监控node机的状态信息。")]),s._v(" "),n("p",[s._v("当某个node机器宕机，controller-manager就会及时排除故障并自动修复。")]),s._v(" "),n("p",[s._v("node节点机上的kubelet进程每隔一段时间周期就会调用一次apiservice接口报告自身状态，apiservice接口接受到这些信息后将节点状态更新到ectd中。kubelet也通过apiservice的监听接口监听pod信息，如果监控到新的pod副本被调度绑定到本节点，则执行pod对应的容器的创建和启动，如果监听到pod对象被删除，则删除本节点对应的pod容器。")]),s._v(" "),n("h2",{attrs:{id:"kubernetes-install"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-install","aria-hidden":"true"}},[s._v("#")]),s._v(" Kubernetes install")]),s._v(" "),n("h3",{attrs:{id:"ubuntu"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ubuntu","aria-hidden":"true"}},[s._v("#")]),s._v(" Ubuntu")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y apt-transport-https\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装依赖")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" apt-key "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" - \n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" \n/etc/apt/sources.list.d/kubernetes.list\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置k8s源")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubelet kubeadm kubectl -y\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装主体")]),s._v("\napt-mark hold kubelet kubeadm kubectl\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 标记指定软件包为保留,阻止软件自动更新")]),s._v("\nswapoff -a\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭虚拟缓存")]),s._v("\nsysctl net.bridge.bridge-nf-call-iptables"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启网桥")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h2",{attrs:{id:"kubernetes-config"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-config","aria-hidden":"true"}},[s._v("#")]),s._v(" Kubernetes config")]),s._v(" "),n("h3",{attrs:{id:"master-config"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#master-config","aria-hidden":"true"}},[s._v("#")]),s._v(" Master config")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("kubeadm init --pod-network-cidr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16 --ignore-preflight-errors"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NumCPU\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化并获取 (kubeadm join)")]),s._v("\n\nex:\n如果缺少包可手动进行下载:\ndocker pull mirrorgooglecontainers/kube-apiserver:v1.14.2\ndocker pull mirrorgooglecontainers/kube-controller-manager:v1.14.2\ndocker pull mirrorgooglecontainers/kube-scheduler:v1.14.2\ndocker pull mirrorgooglecontainers/kube-proxy:v1.14.2\ndocker pull mirrorgooglecontainers/pause:3.1\ndocker pull mirrorgooglecontainers/etcd:3.3.10\ndocker pull hub-mirror.c.163.com/coredns/coredns:1.3.1\n\ndocker tag mirrorgooglecontainers/kube-proxy:v1.14.2 k8s.gcr.io/kube-proxy:v1.14.2\ndocker tag mirrorgooglecontainers/kube-apiserver:v1.14.2 k8s.gcr.io/kube-apiserver:v1.14.2\ndocker tag mirrorgooglecontainers/kube-controller-manager:v1.14.2 k8s.gcr.io/kube-controller-manager:v1.14.2\ndocker tag mirrorgooglecontainers/kube-scheduler:v1.14.2 k8s.gcr.io/kube-scheduler:v1.14.2\ndocker tag hub-mirror.c.163.com/coredns/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1\ndocker tag mirrorgooglecontainers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10\ndocker tag mirrorgooglecontainers/pause:3.1 k8s.gcr.io/pause:3.1\n\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -i /etc/kubernetes/admin.conf "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -u"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -g"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n\n只在主节点设置"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("网络设置"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -O https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" kube-flannel.yml\n添加到 tolerations:\n-key: node.kubernetes.io/not-ready\n operator: Exists\n effect: NoSchedule\n\nkubectl apply -f kube-flannel.yml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("h3",{attrs:{id:"node-config"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#node-config","aria-hidden":"true"}},[s._v("#")]),s._v(" Node config")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("在node上执行kubeadm reset可以断开node，重新join\n在master上执行kubeadm reset可以重新init "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("初始化"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"add-node"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#add-node","aria-hidden":"true"}},[s._v("#")]),s._v(" add node")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("\n添加节点 node\n只需要运行master的 kubeadm "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v("\n\n如果默认源无法下载可能会导致以下问题\nkubectl get node\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示node状态")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果node组件未在运行")]),s._v("\nkubectl get po --all-namespaces\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示组件状态")]),s._v("\nkube describe po kube-proxy-zw64q -n kube-system\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示组件详情")]),s._v("\n\n源:\nkeveon\nmirrorgooglecontainers\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"reboot"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reboot","aria-hidden":"true"}},[s._v("#")]),s._v(" reboot")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("重启后，\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".swapoff -a\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".systemctl daemon-reload\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(".systemctl restart kubelet\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);